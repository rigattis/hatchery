{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/machine_detail.css' %}">
<link rel="stylesheet" href="{% static 'css/machine_list_css.css' %}">

<div class="container py-3">
  <h2 class="mb-3">Machines</h2>

  <form method="GET" class="row g-2 mb-3">
    <div class="col-sm-4">
      <input type="text" name="q" class="form-control"
             placeholder="Search by name or ID" value="{{ query }}">
    </div>

    <div class="col-sm-3">
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for value, label in form.fields.category.choices %}
          <option value="{{ value }}" {% if category == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-sm-3">
      <select name="space_location" class="form-select">
        <option value="">All Locations</option>
        {% for loc in space_locations %}
          <option value="{{ loc }}" {% if space_location == loc %}selected{% endif %}>{{ loc }}</option>
        {% endfor %}
      </select>
    </div>


    <div class="col-sm-2">
      <button type="submit" class="btn btn-primary w-100">Search</button>
    </div>
  </form>

{% if user.is_authenticated %}
  {% if user.is_superuser or user.is_staff %}
    <section class="machine-container">
      <div class="buttons">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMachineModal">
          Add New Machine
        </button>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addExistingMachineModal">
          Add Existing Machine
        </button>
      </div>
  {% else %}
    {% if user.person %}
      {% if user.person.role == "Staff" %}
        <section class="machine-container">
        <div class="buttons">
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMachineModal">
            Add New Machine
          </button>
          <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addExistingMachineModal">
            Add Existing Machine
          </button>
        </div>
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}


  <!-- Machines Grid -->
  <div class="machines-grid">
    {% if object_list %}
      {% for m in object_list %}
        <a href="{% url 'machine_by_name' m.name %}" class="machine-tile">
          <div class="machine-icon">
            {% if m.machine_image %}
              <img src="{{ m.machine_image.url }}" alt="{{ m.name }}">
            {% else %}
              <p>No image available</p>
            {% endif %}
          </div>
          <div class="machine-info">
            <h3 class="machine-name">{{ m.name }}</h3>
            <p class="machine-category">{{ m.category }}</p>
            
            {% if m.all_locations %}
              {% for l in m.all_locations %}
                <p class="machine-location">üìç {{ l }}</p>
              {% endfor %}
            {% else %}
              <p class="machine-location">No locations</p>
            {% endif %}
          </div>
        </a>
      {% endfor %}
    {% else %}
      <p>No machines yet.</p>
    {% endif %}
  </div>

  <!-- Modal  New Machine -->
  <div class="modal fade" id="addMachineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{% url 'machine_create' %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Add New Machine</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {{ form_new.as_p }}
          </div>
          <div class="modal-footer d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% if open_modal == "new" or form_new.errors %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var el = document.getElementById('addMachineModal');
      if (el) new bootstrap.Modal(el).show();
    });
  </script>
  {% endif %}

  <!-- Modal  Existing Machine -->
  <div class="modal fade" id="addExistingMachineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{% url 'existing_machine_create' %}">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Add Existing Machine</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {{ form_existing.as_p }}
          </div>
          <div class="modal-footer d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- JS to populate Existing Machine info -->
  <script>
    const machinesData = JSON.parse(document.getElementById('machines-data').textContent);
    document.addEventListener("DOMContentLoaded", function () {
      const modal = document.getElementById("addExistingMachineModal");
      if (!modal) return;

      const machineSelect = modal.querySelector("#id_name");
      const categoryField = modal.querySelector("#id_category_display");
      const aboutField = modal.querySelector("#id_about_display");
      const specsField = modal.querySelector("#id_specifications_display");

      if (!machineSelect) return;

      function updateMachineInfo() {
        const selectedName = machineSelect.value;
        const machine = machinesData.find(m => m.name === selectedName);
        if (machine) {
          if (categoryField) categoryField.value = machine.category || "";
          if (aboutField) aboutField.value = machine.about || "";
          if (specsField) specsField.value = machine.specifications || "";
        } else {
          if (categoryField) categoryField.value = "";
          if (aboutField) aboutField.value = "";
          if (specsField) specsField.value = "";
        }
      }

      machineSelect.addEventListener("change", updateMachineInfo);
      updateMachineInfo();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</div>
{% endblock %}
