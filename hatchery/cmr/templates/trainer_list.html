{% extends "base.html" %}
{% load static %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<style>
  .trainer-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
  }
  .trainer-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .trainer-color-box {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.2);
  }
  #calendar {
    margin-top: 20px;
  }
  .fc-event {
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">
  <h2 class="mb-3">Trainers</h2>

  <!-- Search/Filter -->
  <!-- Use explicit inputs so GET params are predictable and selection persists -->
  <form method="get" class="row g-2 mb-2 align-items-end" role="search">
    <div class="col-sm-6">
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Search name or ID">
    </div>

    <div class="col-sm-4">
      <select name="training_certificates" class="form-select">
        <option value="">All Certificates</option>
        {% for value, label in category_choices %}
          <option value="{{ value }}"{% if value == training_certificates %} selected{% endif %}>
          {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-2">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <div class="mb-3 d-flex gap-2">
    {% if user.is_authenticated %}
      {% if user.is_superuser or user.is_staff %}
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTrainerModal">Add New Trainer</button>
      {% else %}
        {% if user.person %}
          {% if user.person.role == "Staff" %}
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTrainerModal">Add New Trainer</button>
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
    <button class="btn btn-primary" onclick="toggleCalendarView()">
      <span id="calendarToggleText">ðŸ“… View All Trainers Calendar</span>
    </button>
  </div>

  <!-- Calendar View Section (Hidden by default) -->
  <div id="calendarViewSection" style="display: none;">
    <hr>
    <h3 class="mb-3">All Trainers Schedule</h3>
    
    <!-- Legend -->
    <div class="trainer-legend" id="trainerLegend">
      <!-- Will be populated by JavaScript -->
    </div>
    
    <!-- Calendar -->
    <div id="calendar"></div>
    <hr>
  </div>

  <!-- Grid -->
  <div class="row row-cols-1 row-cols-md-3 g-3">
    {% for t in object_list %}
      <div class="col">
        <div class="card h-100 shadow-sm">
          {% if t.trainer_image %}
            <img src="{{ t.trainer_image.url }}" class="card-img-top" alt="{{ t.name }}">
          {% endif %}
          <div class="card-body">
            <h5 class="card-title"><a href="{% url 'trainer_detail' t.pk %}">{{ t.name }}</a></h5>
            <p class="mb-1"><strong>ID:</strong> {{ t.custom_id|default:"â€”" }}</p>
            <p class="mb-0"><strong>Major:</strong> {{ t.major|default:"â€”" }}</p>
          </div>
          <div class="card-footer bg-transparent border-0">
            <div class="d-flex gap-2">
              {% if user.is_authenticated %}
                {% if user.is_superuser or user.is_staff %}
                  <button class="btn btn-sm" style="background: #5E48AD; color: white; font-weight: 600;" data-bs-toggle="modal" data-bs-target="#editTrainerModal{{ t.pk }}">Edit</button>
                {% else %}
                  {% if user.person %}
                    {% if user.person.role == "Staff" %}
                      <button class="btn btn-sm" style="background: #5E48AD; color: white; font-weight: 600;" data-bs-toggle="modal" data-bs-target="#editTrainerModal{{ t.pk }}">Edit</button>
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% empty %}
      <p>No trainers found.</p>
    {% endfor %}
  </div>
</div>

<!-- Edit Modals for each trainer -->
{% for t in object_list %}
<div class="modal fade" id="editTrainerModal{{ t.pk }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Trainer: {{ t.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'trainer_edit' t.pk %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label for="id_custom_id_{{ t.pk }}" class="form-label">Custom ID</label>
            <input type="text" name="custom_id" value="{{ t.custom_id }}" class="form-control" id="id_custom_id_{{ t.pk }}" required>
          </div>
          <div class="mb-3">
            <label for="id_name_{{ t.pk }}" class="form-label">Name</label>
            <input type="text" name="name" value="{{ t.name }}" class="form-control" id="id_name_{{ t.pk }}" required>
          </div>
          <div class="mb-3">
            <label for="id_major_{{ t.pk }}" class="form-label">Major</label>
            <input type="text" name="major" value="{{ t.major }}" class="form-control" id="id_major_{{ t.pk }}">
          </div>
          <div class="mb-3">
            <label for="id_training_certificates_{{ t.pk }}" class="form-label">
              Training Certificates
            </label>
            <select
              name="training_certificates"
              id="id_training_certificates_{{ t.pk }}"
              class="form-select"
              multiple
              size="6"
            >
            {% with t.training_certificates|default_if_none:"" as certs %}
              {% for value, label in form_new.training_certificates.field.choices %}
                <option value="{{ value }}"{% if value in certs %} selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            {% endwith %}
          </select>
          <div class="form-text">
            Hold Ctrl (Cmd on Mac) to select multiple categories.
          </div>
        </div>

          <div class="mb-3">
            <label for="id_trainer_image_{{ t.pk }}" class="form-label">Trainer Image</label>
            {% if t.trainer_image %}
              <p class="text-muted small">Current: <a href="{{ t.trainer_image.url }}" target="_blank">View Image</a></p>
            {% endif %}
            <input type="file" name="trainer_image" class="form-control" id="id_trainer_image_{{ t.pk }}" accept="image/*">
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Save Changes</button>
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn" style="background: #cdd416; color: white; font-weight: 600; margin-left: auto;" type="button" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#deleteTrainerModal{{ t.pk }}">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTrainerModal{{ t.pk }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Trainer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong>{{ t.name }}</strong>?</p>
        <p class="text-danger">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <form method="POST" action="{% url 'trainer_delete' t.pk %}">
          {% csrf_token %}
          <button class="btn" style="background: #cdd416; color: white; font-weight: 600;" type="submit">Delete</button>
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Add New Trainer Modal -->
<div class="modal fade" id="addTrainerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Trainer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'trainer_create' %}" enctype="multipart/form-data" class="space-form">
          {% csrf_token %}
          {% if form_new.errors %}
            <div class="alert alert-danger">
              <strong>Please correct the following errors:</strong>
              <ul class="mb-0">
                {% for field in form_new %}
                  {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                  {% endfor %}
                {% endfor %}
                {% for error in form_new.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
          {{ form_new.as_p }}
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">Save</button>
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" id="editReservationForm">
        {% csrf_token %}
        <input type="hidden" name="redirect_to" value="trainer_list">
        <div class="modal-header">
          <h5 class="modal-title" id="editReservationModalLabel">Edit Reservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Trainer</label>
            <div>
              <a href="#" id="trainerLink" target="_blank" class="btn btn-sm btn-outline-primary">
                <span id="trainerNameDisplay"></span> â†’
              </a>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="edit_reservation_title" class="form-label">Reservation title</label>
            <input type="text" class="form-control" id="edit_reservation_title" name="reservation_title" required>
          </div>

          <div class="mb-3">
            <label for="edit_date" class="form-label">Date</label>
            <input type="date" class="form-control" id="edit_date" name="date" required>
          </div>

          <div class="row">
            <div class="col">
              <label for="edit_start_time" class="form-label">Start time</label>
              <input type="time" class="form-control" id="edit_start_time" name="start_time" required>
            </div>
            <div class="col">
              <label for="edit_end_time" class="form-label">End time</label>
              <input type="time" class="form-control" id="edit_end_time" name="end_time" required>
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label for="edit_notes" class="form-label">Notes</label>
            <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
          </div>
          
          <!-- Status Display and Approval Section -->
          <div id="statusSection" class="mb-3" style="display: none;">
            <div class="alert alert-info">
              <strong>Status:</strong> <span id="reservationStatus"></span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="deleteReservationBtn">Delete</button>
          <!-- Approval Buttons (only shown for pending reservations) -->
          <div id="approvalButtons" style="display: none; margin-right: auto;">
            <button type="button" class="btn btn-success me-2" id="approveReservationBtn">âœ“ Approve</button>
            <button type="button" class="btn btn-warning" id="rejectReservationBtn">âœ— Reject</button>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% if open_modal == "new" or form_new.errors %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  var el = document.getElementById('addTrainerModal');
  if (el) new bootstrap.Modal(el).show();
});
</script>
{% endif %}

<script>
  let calendar = null;
  let calendarVisible = false;
  
  // Color palette for trainers
  const trainerColors = [
    '#3788d8', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
    '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
    '#d35400', '#8e44ad', '#27ae60', '#2980b9', '#f1c40f'
  ];
  
  const trainerColorMap = {};
  
  function toggleCalendarView() {
    const calendarSection = document.getElementById('calendarViewSection');
    const toggleText = document.getElementById('calendarToggleText');
    
    calendarVisible = !calendarVisible;
    
    if (calendarVisible) {
      calendarSection.style.display = 'block';
      toggleText.textContent = 'ðŸ“‹ View Trainers List';
      
      if (!calendar) {
        initializeCalendar();
      }
    } else {
      calendarSection.style.display = 'none';
      toggleText.textContent = 'ðŸ“… View All Trainers Calendar';
    }
  }
  
  function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    const calendarHeight = Math.max(600, Math.floor(window.innerHeight * 0.65));
    
    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      slotMinTime: '08:00:00',
      slotMaxTime: '22:00:00',
      height: calendarHeight,
      expandRows: true,
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek,timeGridDay'
      },
      nowIndicator: true,
      events: '/trainers/all/reservations/',
      eventDataTransform: function(data) {
        const trainerId = data.trainer__id;
        const trainerName = data.trainer__name;
        const status = data.status || 'approved';
        
        // Assign color to trainer if not already assigned
        if (!trainerColorMap[trainerId]) {
          const colorIndex = Object.keys(trainerColorMap).length % trainerColors.length;
          trainerColorMap[trainerId] = {
            color: trainerColors[colorIndex],
            name: trainerName
          };
          updateLegend();
        }
        
        const baseColor = trainerColorMap[trainerId].color;
        
        // Convert hex to rgba for pending events
        let backgroundColor, borderColor, textColor;
        if (status === 'pending') {
          // Make it faint/translucent
          backgroundColor = baseColor + '40'; // 40 is ~25% opacity in hex
          borderColor = baseColor + '80'; // 80 is ~50% opacity
          textColor = '#6b7280'; // Gray text
        } else {
          backgroundColor = baseColor;
          borderColor = baseColor;
          textColor = '#ffffff';
        }
        
        return {
          id: data.id,
          title: data.reservation_title + ' (' + trainerName + ')',
          start: data.date + 'T' + data.start_time,
          end: data.date + 'T' + data.end_time,
          backgroundColor: backgroundColor,
          borderColor: borderColor,
          textColor: textColor,
          extendedProps: {
            trainerId: trainerId,
            trainerName: trainerName,
            username: data.user__username,
            status: status
          }
        };
      },
      eventClick: function(info) {
        // Get the reservation data
        const reservationId = info.event.id;
        const title = info.event.title;
        const start = info.event.start;
        const end = info.event.end;
        const trainerId = info.event.extendedProps.trainerId;
        const trainerName = info.event.extendedProps.trainerName;
        const status = info.event.extendedProps.status || 'approved';
        
        // Format date and time for input fields
        const dateStr = start.toISOString().split('T')[0];
        const startTimeStr = start.toTimeString().slice(0, 5);
        const endTimeStr = end.toTimeString().slice(0, 5);
        
        // Extract just the reservation title (remove trainer name)
        const reservationTitle = title.replace(` (${trainerName})`, '');
        
        // Populate the edit form
        document.getElementById('edit_reservation_title').value = reservationTitle;
        document.getElementById('edit_date').value = dateStr;
        document.getElementById('edit_start_time').value = startTimeStr;
        document.getElementById('edit_end_time').value = endTimeStr;
        
        // Set trainer link
        const trainerLink = document.getElementById('trainerLink');
        const trainerNameDisplay = document.getElementById('trainerNameDisplay');
        trainerLink.href = `/trainers/${trainerId}/`;
        trainerNameDisplay.textContent = trainerName;
        
        // Show status section
        const statusSection = document.getElementById('statusSection');
        const reservationStatus = document.getElementById('reservationStatus');
        const statusText = status.charAt(0).toUpperCase() + status.slice(1);
        reservationStatus.textContent = statusText;
        statusSection.style.display = 'block';
        
        // Show approval buttons for authenticated users and pending reservations
        const approvalButtons = document.getElementById('approvalButtons');
        const isAuthenticated = {{ request.user.is_authenticated|yesno:"true,false" }};
        
        if (isAuthenticated && status === 'pending') {
          approvalButtons.style.display = 'flex';
          
          // Set up approve button
          const approveBtn = document.getElementById('approveReservationBtn');
          approveBtn.onclick = function() {
            const approveForm = document.createElement('form');
            approveForm.method = 'POST';
            approveForm.action = `/trainers/${trainerId}/reservations/${reservationId}/approve/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            approveForm.appendChild(csrfInput);
            
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'approve';
            approveForm.appendChild(actionInput);
            
            const redirectInput = document.createElement('input');
            redirectInput.type = 'hidden';
            redirectInput.name = 'redirect_to';
            redirectInput.value = 'trainer_list';
            approveForm.appendChild(redirectInput);
            
            document.body.appendChild(approveForm);
            approveForm.submit();
          };
          
          // Set up reject button
          const rejectBtn = document.getElementById('rejectReservationBtn');
          rejectBtn.onclick = function() {
            if (confirm('Are you sure you want to reject this reservation?')) {
              const rejectForm = document.createElement('form');
              rejectForm.method = 'POST';
              rejectForm.action = `/trainers/${trainerId}/reservations/${reservationId}/approve/`;
              
              const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = 'csrfmiddlewaretoken';
              csrfInput.value = csrfToken;
              rejectForm.appendChild(csrfInput);
              
              const actionInput = document.createElement('input');
              actionInput.type = 'hidden';
              actionInput.name = 'action';
              actionInput.value = 'reject';
              rejectForm.appendChild(actionInput);
              
              const redirectInput = document.createElement('input');
              redirectInput.type = 'hidden';
              redirectInput.name = 'redirect_to';
              redirectInput.value = 'trainer_list';
              rejectForm.appendChild(redirectInput);
              
              document.body.appendChild(rejectForm);
              rejectForm.submit();
            }
          };
        } else {
          approvalButtons.style.display = 'none';
        }
        
        // Set the form action URL for editing
        const editForm = document.getElementById('editReservationForm');
        editForm.action = `/trainers/${trainerId}/reservations/${reservationId}/edit/`;
        
        // Set up delete button
        const deleteBtn = document.getElementById('deleteReservationBtn');
        deleteBtn.onclick = function() {
          if (confirm('Are you sure you want to delete this reservation?')) {
            const deleteForm = document.createElement('form');
            deleteForm.method = 'POST';
            deleteForm.action = `/trainers/${trainerId}/reservations/${reservationId}/delete/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            deleteForm.appendChild(csrfInput);
            
            const redirectInput = document.createElement('input');
            redirectInput.type = 'hidden';
            redirectInput.name = 'redirect_to';
            redirectInput.value = 'trainer_list';
            deleteForm.appendChild(redirectInput);
            
            document.body.appendChild(deleteForm);
            deleteForm.submit();
          }
        };
        
        // Show the edit modal
        const editModal = new bootstrap.Modal(document.getElementById('editReservationModal'));
        editModal.show();
      }
    });
    
    calendar.render();
    
    // Responsive resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (calendar) {
          const newHeight = Math.max(500, Math.floor(window.innerHeight * 0.6));
          calendar.setOption('height', newHeight);
          calendar.updateSize();
        }
      }, 150);
    });
  }
  
  function updateLegend() {
    const legendEl = document.getElementById('trainerLegend');
    legendEl.innerHTML = '';
    
    Object.entries(trainerColorMap).forEach(([trainerId, info]) => {
      const item = document.createElement('div');
      item.className = 'trainer-legend-item';
      item.innerHTML = `
        <div class="trainer-color-box" style="background-color: ${info.color}"></div>
        <span><strong>${info.name}</strong></span>
      `;
      legendEl.appendChild(item);
    });
  }
</script>

{% endblock %}