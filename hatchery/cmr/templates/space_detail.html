{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/space_detail.css' %}">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
{% endblock %}

{% block content %}

{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
</div>
{% endif %}

<div class="container py-3">

  <!-- Back Button -->
  <div class="back-button">
    <a href="{% url 'space-list' %}" class="btn btn-back">← Back To Spaces</a>
  </div>

  <!-- Space Card -->
  <div class="space_card">
    <div class="space_details">
      <h2 class="mb-3">{{ object.title }} {{ object.custom_id }}</h2>
      <p><strong>Location:</strong> {{ object.location }}</p>
      <p><strong>Type:</strong> {{ object.type }}</p>
      <p><strong>Capacity:</strong> {{ object.capacity }} people</p>
      {% if object.current_machine %}
      <p><strong>Machine(s) in this space:</strong> {{ object.current_machine }}</p>
      <p>Please note: Booking this space will create an associated reservation for the machine.</p>
      <p><strong>The following certifications are required to book this space, due to the machine that is installed: </strong></p>
        {% if object.current_machine and object.current_machine.certifications_required.exists %}
          <ul>
            {% for c in object.current_machine.certifications_required.all %}
              <li><strong>{{ c.name }}</strong></li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No certifications are required for this machine.</p>
        {% endif %}
      {% else %}
      <p><strong>This space does not have any machines installed. Booking it will book the space only. To book a machine, go to the machines tab or book a space with a machine associated.</strong></p>
      {% endif %}
      {% if object.notes %}
      <p><strong>Notes:</strong> {{ object.notes }}</p>
      {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      {% if user.is_authenticated %}
      {% if user.is_superuser or user.is_staff %}
          <!-- Edit/Delete buttons -->
          <button type="button" class="btn btn-edit" data-bs-toggle="modal" data-bs-target="#editSpaceModal">
            Edit
          </button>
          <button type="button" class="btn btn-delete" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
            Delete
          </button>
        {% else %}
          {% if user.person %}
            {% if user.person.role == "Staff" %}
              <!-- Edit/Delete buttons -->
              <button type="button" class="btn btn-edit" data-bs-toggle="modal" data-bs-target="#editSpaceModal">
                Edit
              </button>
              <button type="button" class="btn btn-delete" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">
                Delete
              </button>
            {% endif %}
          {% endif %}
        {% endif %}
    {% endif %}

    <!-- Reserve button always visible -->
    <button type="button" class="btn btn-reserve" data-bs-toggle="modal" data-bs-target="#reserveModal">
      Reserve
    </button>

  </div>

</div>

    <!-- Delete Modal -->
    <div class="modal fade styled-modal" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong>{{ object.title }}</strong>? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{% url 'space-delete' object.custom_id %}" method="POST" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-primary">Yes, Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

    <!-- Edit Modal -->
    <div class="modal fade styled-modal" id="editSpaceModal" tabindex="-1" aria-labelledby="editSpaceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'space-edit' object.custom_id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit {{ object.title }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {{ edit_form.as_p }}
          <input type="hidden" name="space" value="{{ object.custom_id }}">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Confirm Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

    <!-- Reservation Modal -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'space-reserve' object.custom_id %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="reserveModalLabel">Reserve {{ object.title }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {% if object.current_machine %}
          <div class="alert alert-warning text-center fw-bold" role="alert">
          ⚠️ Booking this machine will reserve the associated Space AND the current machine installed: <strong> {{ object.current_machine }} </strong>.
          </div>
          {% with required=object.current_machine.certifications_required.all %}
            {% if required %}
                <div class="alert alert-danger fw-bold">
                    ⚠️ Required Training Needed:
                    <ul>
                        {% for item in required %}
                        <li>{{ item.name }}</li>
                        {% endfor %}
                    </ul>
                    {% if not user.person.training_records.all %}
                        <p>You currently have no training records.</p>
                    {% else %}
                        <p>You may not be allowed to reserve this machine.</p>
                    {% endif %}
                </div>
            {% endif %}
        {% endwith %}
          {% else %}
          <div class="alert alert-warning text-center fw-bold" role="alert">
          ⚠️ This space does not have a machine installed. If you need to book a machine, go to the machines page or book the associated space.
          </div>
          {% endif %}

          {% if reservation_form.non_field_errors %}
            <div class="alert alert-danger">
              {{ reservation_form.non_field_errors }}
            </div>
          {% endif %}

          <!-- Show the current object's ID as read-only -->
          <div class="mb-3">
            <label class="form-label">ID:</label>
            <input type="text" class="form-control" value="{{ object.custom_id }}" readonly>
          </div>

          <!-- Render reservation form fields individually for better control -->
          <div class="mb-3">
            {{ reservation_form.reservation_title.label_tag }}
            {{ reservation_form.reservation_title }}
            {{ reservation_form.reservation_title.errors }}
          </div>

          <div class="mb-3">
            {{ reservation_form.date.label_tag }}
            {{ reservation_form.date }}
            {{ reservation_form.date.errors }}
          </div>

          <div class="row">
            <div class="col">
              {{ reservation_form.start_time.label_tag }}
              {{ reservation_form.start_time }}
              {{ reservation_form.start_time.errors }}
            </div>
            <div class="col">
              {{ reservation_form.end_time.label_tag }}
              {{ reservation_form.end_time }}
              {{ reservation_form.end_time.errors }}
            </div>
          </div>

          <div class="mb-3">
            {{ reservation_form.notes.label_tag }}
            {{ reservation_form.notes }}
            {{ reservation_form.notes.errors }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Confirm Reservation</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Reservation Modal -->
<div class="modal fade" id="editReservationModal" tabindex="-1" aria-labelledby="editReservationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" id="editReservationForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editReservationModalLabel">Edit Reservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_reservation_title" class="form-label">Reservation title</label>
            <input type="text" class="form-control" id="edit_reservation_title" name="reservation_title" required>
          </div>

          <div class="mb-3">
            <label for="edit_date" class="form-label">Date</label>
            <input type="date" class="form-control" id="edit_date" name="date" required>
          </div>

          <div class="row">
            <div class="col">
              <label for="edit_start_time" class="form-label">Start time</label>
              <input type="time" class="form-control" id="edit_start_time" name="start_time" required>
            </div>
            <div class="col">
              <label for="edit_end_time" class="form-label">End time</label>
              <input type="time" class="form-control" id="edit_end_time" name="end_time" required>
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label for="edit_notes" class="form-label">Notes</label>
            <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" id="deleteReservationBtn">Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<hr>

{% if object.floorplan_image %}
  <div class="floorplan-container">
    <h3>Floor Plan</h3>
    <img src="{{ object.floorplan_image.url }}" alt="Floor Plan for {{ object.title }}" class="floorplan-image">
  </div>
{% endif %}

<div id="calendar-container" aria-label="Weekly schedule">
  <h4 style="margin-left:16px;">Weekly Calendar</h4>
  <div id="calendar"></div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const calendarEl = document.getElementById("calendar");
    const spaceId = "{{ object.custom_id }}";

    const calendarHeight = Math.max(600, Math.floor(window.innerHeight * 0.65));

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "timeGridWeek",
      slotMinTime: "08:00:00",
      slotMaxTime: "22:00:00",
      height: calendarHeight,
      expandRows: true,
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "timeGridWeek,timeGridDay"
      },
      nowIndicator: true,
      events: `/spaces/${spaceId}/reservations/`,
      eventDataTransform: (data) => ({
        id: data.id,
        title: data.reservation_title,
        start: data.date + "T" + data.start_time,
        end: data.date + "T" + data.end_time,
        extendedProps: {
          username: data.user__username
        }
      }),
      eventDidMount: function(info) {
      const tooltip = new bootstrap.Tooltip(info.el, {
        title: `User: ${info.event.extendedProps.username}\nStart: ${info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}\nEnd: ${info.event.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`,
        placement: 'top',
        trigger: 'hover',
        container: 'body'
      });
    },
      eventClick: function(info) {
        // Get the reservation data
        const reservationId = info.event.id;
        const title = info.event.title;
        const start = info.event.start;
        const end = info.event.end;
        
        // Format date and time for input fields
        const dateStr = start.toISOString().split('T')[0];
        const startTimeStr = start.toTimeString().slice(0, 5);
        const endTimeStr = end.toTimeString().slice(0, 5);
        
        // Populate the edit form
        document.getElementById('edit_reservation_title').value = title;
        document.getElementById('edit_date').value = dateStr;
        document.getElementById('edit_start_time').value = startTimeStr;
        document.getElementById('edit_end_time').value = endTimeStr;
        
        // Set the form action URL for editing
        const editForm = document.getElementById('editReservationForm');
        editForm.action = `/spaces/${spaceId}/reservations/${reservationId}/edit/`;
        
        // Set up delete button
        const deleteBtn = document.getElementById('deleteReservationBtn');
        deleteBtn.onclick = function() {
          if (confirm('Are you sure you want to delete this reservation?')) {
            // Create a form and submit it for deletion
            const deleteForm = document.createElement('form');
            deleteForm.method = 'POST';
            deleteForm.action = `/spaces/${spaceId}/reservations/${reservationId}/delete/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            deleteForm.appendChild(csrfInput);
            
            document.body.appendChild(deleteForm);
            deleteForm.submit();
          }
        };
        
        // Show the edit modal
        const editModal = new bootstrap.Modal(document.getElementById('editReservationModal'));
        editModal.show();
      }
    });

    calendar.render();

    requestAnimationFrame(() => calendar.updateSize());


    let resizeTimeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const newHeight = Math.max(500, Math.floor(window.innerHeight * 0.6));
        calendar.setOption('height', newHeight);
        calendar.updateSize();
      }, 150);
    });
  });
</script>

</div>
{% endblock %}